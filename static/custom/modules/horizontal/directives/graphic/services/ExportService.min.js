define(function(require){var html2canvas=require("common-exporting/html2canvas"),ExportService=function($log,$q){function Utf8Encode(strUni){return String(strUni).replace(/[\u0080-\u07ff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(192|cc>>6,128|63&cc)}).replace(/[\u0800-\uffff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(224|cc>>12,128|cc>>6&63,128|63&cc)})}function round(value,precision){var multiplier=Math.pow(10,precision||0);return Math.round(value*multiplier)/multiplier}var ExportPopupComponent=require("cde/components/ExportPopupComponent"),configService=require("horizontal/config/configService"),i18n=configService.getLiterals();return require("common-exporting/file-saver"),{exportImageAction:function(scope){var node=$("#"+scope.id).parents(".modal-body")[0],svg=document.querySelector(".modal svg"),xml=Utf8Encode((new XMLSerializer).serializeToString(svg)),svg64=btoa(xml),image64="data:image/svg+xml;base64,"+svg64;angular.element(".modal svg").after("<img id='svg2image'>"),document.getElementById("svg2image").src=image64,angular.element(".modal svg").attr("style","display:none"),$(".dropdown").hide(),angular.element("span.btn.pull-right").hide(),angular.element("div.legend-info").attr("style","display:none!important");require("es6-promise").Promise;html2canvas(node).then(function(canvas){canvas.toBlob(function(blob){if("undefined"==scope.chartTitle||void 0==scope.chartTitle){scope.titleH2=$("#"+scope.id).parents().find("h2:eq(0)").text();var filename=scope.titleH2+".png"}else var filename=scope.chartTitle+".png";saveAs(blob,filename),$(".dropdown").show(),angular.element("span.btn.pull-right").show(),$("#svg2image").remove(),angular.element(".modal svg").removeAttr("style")})},function(error){})},exportDataAction:function(scope,dashboard){var title="chart-data";""!=scope.chartTitle?title=scope.chartTitle:""!=scope.longTitle&&(title=scope.longTitle),title=title.replace(/;/g," ").replace(/,/g," ").replace(/ +/g,"_");var exportDefinition={type:"ExportPopupComponent",dataExportAttachmentName:title},component=""+scope.id;exportDefinition.dataExportType="csv",exportDefinition.dataComponent=dashboard.dashboard.getComponentByName(component);var exportComponent=new ExportPopupComponent(exportDefinition);exportComponent.dashboard=dashboard.dashboard;var columns="",numberColumns=exportComponent.dataComponent.chart.metadata.length;for(i=0;i<numberColumns;i++)columns+=exportComponent.dataComponent.chart.metadata[i].colName+";";columns=columns.substring(0,columns.length-1);var data="";for(i=0;i<exportComponent.dataComponent.chart.resultset.length;i++){var dataTMP=exportComponent.dataComponent.chart.resultset[i];for(a=0;a<dataTMP.length;a++){var value=exportComponent.dataComponent.chart.resultset[i][a];"getSectorActivityData"==exportComponent.dataComponent.chartDefinition.dataAccessId&&1==a&&(value=i18n["L"+value]),!isNaN(value)&&(value<-1||value>-1&&value<0)?data+=Math.abs(value)+";":($.isNumeric(value)&&value%1>0&&(value=round(value,1)),data+=value+";")}data=data.substring(0,data.length-1)+"\n"}data+="\n\n",data+=i18n.L20387,function(){var csv="\ufeff"+columns+"\n"+data,blob=new Blob([csv],{type:"text/csv;charset=UTF-8"});saveAs(blob,title+".csv")}()},exportRadarData:function(promises,titleChart,id){$log.warn(promises);var list=[];Promise.all([promises[0],promises[1],promises[2]]).then(function(res){list.push(res[0]),list.push(res[1]),list.push(res[2]);var title="chart-data";""!=titleChart&&(title=titleChart),title=title.replace(/;/g," ").replace(/,/g," ").replace(/ +/g,"_");var exportDefinition={type:"ExportPopupComponent",dataExportAttachmentName:title};exportDefinition.dataExportType="csv",exportDefinition.dataComponent=list;var exportComponent=new ExportPopupComponent(exportDefinition);$log.warn(exportComponent);var columns="",numberColumns=exportComponent.dataComponent[0].data.metadata.length;for(i=0;i<numberColumns;i++)columns+=exportComponent.dataComponent[0].data.metadata[i].colName+";";columns=columns.substring(0,columns.length-1);var data="";for(j=0;j<exportComponent.dataComponent.length;j++)for(i=0;i<exportComponent.dataComponent[j].data.resultset.length;i++){var dataTMP=exportComponent.dataComponent[j].data.resultset[i];for(a=0;a<dataTMP.length;a++){var value=exportComponent.dataComponent[j].data.resultset[i][a];!isNaN(value)&&(value<-1||value>-1&&value<0)?data+=Math.abs(value)+";":($.isNumeric(value)&&value%1>0&&(value=round(value,1)),data+=value+";")}data=data.substring(0,data.length-1)+"\n"}data+="\n\n",data+=i18n.L20387,function(){var csv="\ufeff"+columns+"\n"+data,blob=new Blob([csv],{type:"text/csv;charset=UTF-8"});saveAs(blob,title+".csv")}()})}}};return ExportService.$inject=["$log","$q"],ExportService});