define(function(require){"use strict";function nextId(){return sequence++}function customFunction(scope,attributes,data,$log,mapProvider,dvtUtils,map,indicator,subIndicator){Raphael.fn.map=function(){function labelPath(pathObj,text,textattr){void 0==textattr&&(textattr=mapProvider.getLabelDefinition);var bbox=pathObj.getBBox();if("DK"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/1.25,bbox.y+bbox.height/1.2,text).attr(textattr);else if("NO"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/4,bbox.y+bbox.height/1.25,text).attr(textattr);else if("SE"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/3.75,bbox.y+bbox.height/2,text).attr(textattr);else if("FI"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/1.75,bbox.y+bbox.height/1.3,text).attr(textattr);else if("BE"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/1.75,bbox.y+bbox.height/3,text).attr(textattr);else if("ES"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/2.75,bbox.y+bbox.height/2,text).attr(textattr);else if("HR"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/2,bbox.y+bbox.height/4,text).attr(textattr);else if("UK"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/1.5,bbox.y+bbox.height/1.3,text).attr(textattr);else if("IT"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/1.7,bbox.y+bbox.height/2,text).attr(textattr);else if("EL"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/3.8,bbox.y+bbox.height/2.75,text).attr(textattr);else if("PT"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/2.6,bbox.y+bbox.height/2,text).attr(textattr);else if("AT"==pathObj.id)var textObj=pathObj.paper.text(bbox.x+bbox.width/1.5,bbox.y+bbox.height/2,text).attr(textattr);else var textObj=pathObj.paper.text(bbox.x+bbox.width/2,bbox.y+bbox.height/2,text).attr(textattr);return textObj.id=pathObj.id,textObj.label=pathObj.label,textObj.medianAge=path.medianAge,textObj.ageingWorkers=path.ageingWorkers,textObj.eRateTotal=path.eRateTotal,textObj.eRateMale=path.eRateMale,textObj.eRateFemale=path.eRateFemale,textObj.unemploymentRate=path.unemploymentRate,noDataCountries.indexOf(pathObj.id)<0&&(textObj.click(clicked),$log.debug("Country ID: "+pathObj.id)),textObj}$log.debug("Start Raphael");var i18nLiterals=configService.getLiterals(),country=(mapProvider.getNotEUCountries(),attributes.country);if("EU"!==country)map={shapes:{country:map.shapes[country]},names:{country:map.names[country]}};else var sCountry=map.names[scope.countryKey];var colorIndex=parseInt(attributes.colorIndex)||1,backgroundShapeColor="EU"!==attributes.country||attributes.csp?dvtUtils.getColorCountry(colorIndex):attributes.backgroundShapeColor||dvtUtils.getEUMapBaseColor(),strokeShapeColor=attributes.strokeColor||"EU"===attributes.country?"#fff":backgroundShapeColor,groupColor=scope.groupColor||(scope.groupId?dvtUtils.getGroupColor(scope.groupId[0].toString()):dvtUtils.getEUMapBaseColor()),selectedCountryColor=attributes.selectedCountryColor||dvtUtils.getColorCountry(colorIndex);if(attributes.isColored)var isColoredMap=0!==attributes.isColored;var clicked=scope.clickAction||void 0,over=function(e){if(noDataCountries.indexOf(this.id)<0){this.animate({opacity:.5},100);var elementSVG=angular.element("body");angular.element(elementSVG).append('<div class="dvt-map-tooltip"></div>'),angular.element(".dvt-map-tooltip").append('<p class="country-name"><ul><li class="data1"></li><li class="data2"></li><li class="data5"></li><li class="data4"></li><li class="data3"></li><li class="data6"></li></ul></p>');var unemployment=void 0==this.unemploymentRate?"0":this.unemploymentRate;angular.element(".dvt-map-tooltip .country-name").text(this.label),angular.element(".dvt-map-tooltip .data1").html("<label>"+i18nLiterals.L20615+"</label>"+this.medianAge+" "+i18nLiterals.L20620),angular.element(".dvt-map-tooltip .data2").html("<label>"+i18nLiterals.L20616+"</label>"+this.ageingWorkers+" %"),angular.element(".dvt-map-tooltip .data3").html("<label>"+i18nLiterals.L20617+"</label>"+this.eRateTotal+" %"),angular.element(".dvt-map-tooltip .data4").html("<label>"+i18nLiterals.L20618+"</label>"+this.eRateMale+" %"),angular.element(".dvt-map-tooltip .data5").html("<label>"+i18nLiterals.L20619+"</label>"+this.eRateFemale+" %"),angular.element(".dvt-map-tooltip .data6").html("<label>"+i18nLiterals.L291+"</label>"+unemployment+" %");var widthTooltip=angular.element(".dvt-map-tooltip").width(),heightTooltip=angular.element(".dvt-map-tooltip").height(),positionSVG=elementSVG.position().top+elementSVG.height()/2;angular.element(document).on("mousemove",function(event){event.pageY<positionSVG?(angular.element(".dvt-map-tooltip").removeClass("top"),angular.element(".dvt-map-tooltip").addClass("botton"),angular.element(".dvt-map-tooltip").css({left:event.pageX-widthTooltip/2-25,top:event.pageY+40})):(angular.element(".dvt-map-tooltip").removeClass("botton"),angular.element(".dvt-map-tooltip").addClass("top"),angular.element(".dvt-map-tooltip").css({left:event.pageX-widthTooltip/2-25,top:event.pageY-heightTooltip-80}))})}},out=function(){noDataCountries.indexOf(this.id)<0&&(this.animate({opacity:1},100),angular.element(".dvt-map-tooltip").remove())};this.setStart();var paths=[],noDataCountries=[];void 0!=scope.mapData&&""!=scope.mapData.indicator&&0==Object.keys(scope.data.medianAge).length&&(scope.data=scope.mapData),scope.countryDataToShow=[],"median-age"==scope.data.indicator?scope.countryDataToShow=scope.data.medianAge:"employment-rate"==scope.data.indicator&&"ageing-workers"==scope.data.subIndicator?scope.countryDataToShow=scope.data.ageingWorkers:"employment-rate"==scope.data.indicator&&"Total"==scope.data.subIndicator?scope.countryDataToShow=scope.data.totalEmployment:"employment-rate"==scope.data.indicator&&"Male"==scope.data.subIndicator?scope.countryDataToShow=scope.data.maleEmployment:"employment-rate"==scope.data.indicator&&"Female"==scope.data.subIndicator?scope.countryDataToShow=scope.data.femaleEmployment:"unemployment-rate"==scope.data.indicator&&(scope.countryDataToShow=scope.data.unemploymentRate);var minMaxValues=function(data){var minValue=100,maxValue=0;for(var index in data)data[index].value<minValue&&(minValue=data[index].value),data[index].value>maxValue&&(maxValue=data[index].value);return minValue=minValue,maxValue=maxValue,[minValue,maxValue,(maxValue-minValue)/4]}(scope.countryDataToShow);for(var index in map.shapes){var shape=map.shapes[index],cName=map.names[index],path=this.path(shape);scope.group;path.label=cName,path.id=index;var isInGroup=!1,countryInfo=scope.countryDataToShow[index];if(void 0!=countryInfo){isInGroup=!0,path.medianAge=scope.data.medianAge[index].value,path.ageingWorkers=scope.data.ageingWorkers[index].value,path.eRateTotal=scope.data.totalEmployment[index].value,path.eRateMale=scope.data.maleEmployment[index].value,path.eRateFemale=scope.data.femaleEmployment[index].value,"CH"!=index&&(path.unemploymentRate=scope.data.unemploymentRate[index].value);labelPath(path,index)}else noDataCountries.push(index);isInGroup&&isColoredMap?(mapProvider.nonEUCountry(index)?path.attr({stroke:strokeShapeColor,fill:"url(/pentaho/plugin/pentaho-cdf-dd/api/resources/system/osha-dvt-barometer/static/custom/img/diagonal-stripes.png)","fill-opacity":dvtUtils.getOpacityCountries(countryInfo.value,minMaxValues[0],minMaxValues[1],minMaxValues[2],index),"stroke-opacity":1}):path.attr({stroke:strokeShapeColor,fill:dvtUtils.getRangeColors(countryInfo.value,minMaxValues[0],minMaxValues[1],minMaxValues[2],index),"stroke-opacity":1}),path.group=1,cName===sCountry&&(path.attr({stroke:strokeShapeColor,fill:selectedCountryColor,"stroke-opacity":1}),path.group=1)):(noDataCountries.indexOf(path.id)<0||attributes.csp?path.attr({stroke:strokeShapeColor,fill:backgroundShapeColor,"stroke-opacity":1}):path.attr({stroke:backgroundShapeColor,fill:"#F0F0F0","stroke-opacity":1}),path.group=0),scope.legend&&labelPath(path,cName).attr({fill:groupColor}),paths.push(path),attributes.clickable&&"1"==attributes.clickable&&noDataCountries.indexOf(path.id)<0&&(path.click(clicked),path.attr({cursor:"pointer"}))}var countryMap=this.setFinish();attributes.hover&&"true"==attributes.hover&&countryMap.hover(over,out);var colorAux="";if(attributes.legend&&"1"==attributes.legend)for(var country in paths){colorAux=groupColor;var current=paths[country];colorAux=1==current.group?backgroundShapeColor:groupColor,labelPath(current,current.label).attr({fill:colorAux})}};var paper=Raphael(scope.id,attributes.width||800,attributes.height||800);attributes.useViewbox&&"true"==attributes.useViewbox&&paper.setViewBox(attributes.x||0,attributes.y||0,attributes.zoomH||450,attributes.zoomW||450,!1);var svg=document.querySelector("#"+scope.id+" svg");svg.removeAttribute("width"),configService.isIE()||svg.removeAttribute("height"),svg.setAttribute("style","width:100%"),paper.canvas.setAttribute("preserveAspectRatio","xMaxYMin");try{paper.map()}catch(error){$log.warn("error al renderizar el mapa"),$log.error(error)}}function DvtShapeDirective(dataService,mapProvider,$log,dvtUtils,configService,$stateParams,$rootScope){return{restrict:"E",require:["^dvtDashboard"],priority:6,transclude:!0,scope:{postFetch:"=",promise:"=",countryKey:"=",groupKey:"=",groupColor:"=",groupList:"=",clickAction:"=",data:"="},template:'<div data-ng-class="{{ divClass }}" data-ng-attr-id="{{ id }}"></div>',controller:["$scope","mapProvider","dataService","$attrs","$state",function($scope,mapProvider,dataService,$attrs,$state){state=$state.current.name,$scope.promises={},$scope.mapData={medianAge:[],ageingWorkers:[],totalEmployment:[],maleEmployment:[],femaleEmployment:[],unemploymentRate:[],indicator:"",subIndicator:""},void 0!=$rootScope.data&&($scope.data=$rootScope.data),$scope.promise&&void 0==$rootScope.data&&Promise.all([$scope.promise[1],$scope.promise[2],$scope.promise[3],$scope.promise[4],$scope.promise[5],$scope.promise[6]]).then(function(res){var indicator=$stateParams.pIndicator,subIndicator=$stateParams.pSubIndicator,row={};res[0].data.resultset.map(function(elem){row=elem,$scope.mapData.medianAge[row[0]]||($scope.mapData.medianAge[row[0]]={}),$scope.mapData.medianAge[row[0]].country_name=row[1],$scope.mapData.medianAge[row[0]].value=row[2]});var row={};res[1].data.resultset.map(function(elem){row=elem,$scope.mapData.ageingWorkers[row[0]]||($scope.mapData.ageingWorkers[row[0]]={}),$scope.mapData.ageingWorkers[row[0]].country_name=row[1],$scope.mapData.ageingWorkers[row[0]].value=row[2]});var row={};res[2].data.resultset.map(function(elem){row=elem,$scope.mapData.totalEmployment[row[0]]||($scope.mapData.totalEmployment[row[0]]={}),$scope.mapData.totalEmployment[row[0]].country_name=row[1],$scope.mapData.totalEmployment[row[0]].value=row[2]});var row={};res[3].data.resultset.map(function(elem){row=elem,$scope.mapData.maleEmployment[row[0]]||($scope.mapData.maleEmployment[row[0]]={}),$scope.mapData.maleEmployment[row[0]].country_name=row[1],$scope.mapData.maleEmployment[row[0]].value=row[2]});var row={};res[4].data.resultset.map(function(elem){row=elem,$scope.mapData.femaleEmployment[row[0]]||($scope.mapData.femaleEmployment[row[0]]={}),$scope.mapData.femaleEmployment[row[0]].country_name=row[1],$scope.mapData.femaleEmployment[row[0]].value=row[2]});var row={};res[5].data.resultset.map(function(elem){row=elem,$scope.mapData.unemploymentRate[row[0]]||($scope.mapData.unemploymentRate[row[0]]={}),$scope.mapData.unemploymentRate[row[0]].country_name=row[1],$scope.mapData.unemploymentRate[row[0]].value=row[2]}),$scope.mapData.indicator=indicator,$scope.mapData.subIndicator=subIndicator,$rootScope.data=$scope.mapData,$scope.data=$scope.mapData}),$scope.map={},$log.debug("I'm-------------------MAP")}],link:function(scope,element,attributes,controllers){var dashboard=controllers[0];scope.id="dvt_map"+nextId(),scope.promise?void 0==$rootScope.data?Promise.all([scope.promise[0],scope.promise[1],scope.promise[2],scope.promise[3],scope.promise[4],scope.promise[5],scope.promise[6]]).then(function(res){var row={};res[1].data.resultset.map(function(elem){row=elem,scope.mapData.medianAge[row[0]]||(scope.mapData.medianAge[row[0]]={}),scope.mapData.medianAge[row[0]].country_name=row[1],scope.mapData.medianAge[row[0]].value=row[2]});var row={};res[2].data.resultset.map(function(elem){row=elem,scope.mapData.ageingWorkers[row[0]]||(scope.mapData.ageingWorkers[row[0]]={}),scope.mapData.ageingWorkers[row[0]].country_name=row[1],scope.mapData.ageingWorkers[row[0]].value=row[2]});var row={};res[3].data.resultset.map(function(elem){row=elem,scope.mapData.totalEmployment[row[0]]||(scope.mapData.totalEmployment[row[0]]={}),scope.mapData.totalEmployment[row[0]].country_name=row[1],scope.mapData.totalEmployment[row[0]].value=row[2]});var row={};res[4].data.resultset.map(function(elem){row=elem,scope.mapData.maleEmployment[row[0]]||(scope.mapData.maleEmployment[row[0]]={}),scope.mapData.maleEmployment[row[0]].country_name=row[1],scope.mapData.maleEmployment[row[0]].value=row[2]});var row={};res[5].data.resultset.map(function(elem){row=elem,scope.mapData.femaleEmployment[row[0]]||(scope.mapData.femaleEmployment[row[0]]={}),scope.mapData.femaleEmployment[row[0]].country_name=row[1],scope.mapData.femaleEmployment[row[0]].value=row[2]});var row={};res[6].data.resultset.map(function(elem){row=elem,scope.mapData.unemploymentRate[row[0]]||(scope.mapData.unemploymentRate[row[0]]={}),scope.mapData.unemploymentRate[row[0]].country_name=row[1],scope.mapData.unemploymentRate[row[0]].value=row[2]}),$rootScope.data=scope.mapData,scope.data=scope.mapData,scope.divClass=attributes.cssClass;var map=res[0].data,definition={type:"raphaelComponent",name:scope.id,priority:attributes.priority||100,parameters:[],executeAtStart:!1,width:attributes.width||1e3,height:attributes.height||600,htmlObject:scope.id,listeners:[],data:scope.data,customfunction:customFunction(scope,attributes,scope.data,$log,mapProvider,dvtUtils,map)};if(scope.params&&(definition.parameters=scope.params),scope.listenTo)for(var listen in scope.listenTo)definition.listeners[listen]=scope.listenTo[listen];attributes.hover&&(scope.hover=1==attributes.hover),scope.postFetch&&(definition.postFetch=scope.postFetch),attributes.width&&(scope.width=attributes.width),attributes.height&&(scope.height=attributes.height),attributes.x&&(scope.x=attributes.x),attributes.y&&(scope.y=attributes.y);var chart=new RaphaelComponent(definition);dashboard.register(chart),chart.postExecution=function(){this.width=this.placeholder().width()},$log.debug("Link function of "+scope.id)}):scope.promise[0].then(function(map){scope.divClass=attributes.cssClass;var map=map.data,definition={type:"raphaelComponent",name:scope.id,priority:attributes.priority||100,parameters:[],executeAtStart:!1,width:attributes.width||1e3,height:attributes.height||600,htmlObject:scope.id,listeners:[],data:scope.data,customfunction:customFunction(scope,attributes,scope.data,$log,mapProvider,dvtUtils,map)};if(scope.params&&(definition.parameters=scope.params),scope.listenTo)for(var listen in scope.listenTo)definition.listeners[listen]=scope.listenTo[listen];attributes.hover&&(scope.hover=1==attributes.hover),scope.postFetch&&(definition.postFetch=scope.postFetch),attributes.width&&(scope.width=attributes.width),attributes.height&&(scope.height=attributes.height),attributes.x&&(scope.x=attributes.x),attributes.y&&(scope.y=attributes.y);var chart=new RaphaelComponent(definition);dashboard.register(chart),chart.postExecution=function(){this.width=this.placeholder().width()},$log.debug("Link function of "+scope.id)}):($log.error("Link function of "+scope.id+": Promise is undefined"),console.log("Link function of "+scope.id+": Promise is undefined"))}}}var state,RaphaelComponent=require("cde/components/RaphaelComponent"),configService=require("horizontal/config/configService"),sequence=1;return DvtShapeDirective.$inject=["dataService","mapProvider","$log","dvtUtils","configService","$stateParams","$rootScope"],DvtShapeDirective});