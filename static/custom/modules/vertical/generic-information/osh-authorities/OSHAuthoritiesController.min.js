define(function(require){"use strict";function controller($scope,$stateParams,$state,configService,$log,$document,dataService,$window,$sce,$compile,$timeout,$rootScope){function search($event,filter){dataService.getSearchTerm($scope.searchText,$scope.searchParams.institutions,$scope.searchParams.countries).then(function(data){$scope.amatrix=dataService.dataMapper(data),$scope.firstPage(),$state.transitionTo("osh-authorities",{},{notify:!1})}).catch(function(err){throw err}),$scope.currentPage=0}var i18n=require("json!vertical/osh-authorities/i18n"),i18nLiterals=configService.getLiterals();$scope.i18n=i18n,$scope.i18nLiterals=i18nLiterals;var i18nSearch=require("json!horizontal/search/i18n");$scope.i18nSearch=i18nSearch,$scope.i18nSearchPlaceholder=i18nSearch["authorities-search-placeholder"],$scope.countries=[],$scope.amatrix=[],$scope.searchParams={institutions:{filter1:0,filter2:0,filter3:0,filter4:0},countries:[]},$scope.searchText="",$scope.selectedCountries=[],$scope.deleteCountryTags=[],$scope.currentPage=0,$scope.pageSize=5,$scope.elementsStart=0,$scope.elementsEnd=$scope.pageSize,void 0!=$rootScope.defaultCountry.code&&1==$rootScope.defaultCountry.selectedByUser?$scope.pCountry=$rootScope.defaultCountry.code:$scope.pCountry=$stateParams.pCountry,$scope.pInstitution=$stateParams.pInstitution,$scope.paginationText="Displaying "+($scope.elementsStart+1)+"-"+$scope.elementsEnd+" of "+$scope.amatrix.length;var updateText=function(){$scope.paginationText="Displaying "+($scope.elementsStart+1)+"-"+$scope.elementsEnd+" of "+$scope.amatrix.length};if($scope.openSelect=function($event){var currentSelect=$event.target,nodename=currentSelect.nodeName;"LABEL"==nodename||"INPUT"==nodename?(currentSelect=$event.target.offsetParent.offsetParent,angular.element(currentSelect).addClass("viewOptions")):(currentSelect=$event.target.offsetParent.offsetParent,$scope.checkSelect(currentSelect))},$scope.checkSelect=function(elem){elem.className.indexOf("viewOptions")>0?angular.element(elem).removeClass("viewOptions"):(angular.element(".filter--dropdown--wrapper").removeClass("viewOptions"),angular.element(elem).addClass("viewOptions"))},$scope.closeSelect=function($event){angular.element(".filter--dropdown--wrapper").removeClass("viewOptions")},$scope.trimtext=function(pVal,pNumCharacters){var shortText=pVal,newMaxCharacter=pNumCharacters;if(null!=shortText){return shortText.substring(0,newMaxCharacter).match("<a")&&(newMaxCharacter+=150),shortText.length>pNumCharacters&&(shortText=$.trim(shortText).substring(0,newMaxCharacter).split(" ").slice(0,-1).join(" ")+"<span class='dots'>...</span>"),$sce.trustAsHtml(shortText)}},$scope.longText=function(pVal,pNumCharacters){return"<samp style='display:none'> "+pVal.split(" ").slice($.trim(pVal).substring(0,pNumCharacters).split(" ").slice(0,-1).length).join(" ")+"</samp>"},$scope.toggleText=function($event){$(this).is(":visible")&&("A"==$event.target.nodeName?(angular.element("div.complete-text",angular.element($event.target).parent().parent()).toggle(),angular.element("div.partial-text",angular.element($event.target).parent().parent()).toggle(),angular.element(" span.dots",angular.element($event.target).parent().parent()).toggle(),angular.element(" a",angular.element($event.target).parent()).toggle()):"FONT"==$event.target.nodeName?(angular.element("div.complete-text",angular.element($event.target).parent().parent().parent().parent()).toggle(),angular.element("div.partial-text",angular.element($event.target).parent().parent().parent().parent()).toggle(),angular.element(" span.dots",angular.element($event.target).parent().parent().parent().parent()).toggle(),angular.element(" a",angular.element($event.target).parent().parent().parent()).toggle()):"I"==$event.target.nodeName&&(angular.element("div.complete-text",angular.element($event.target).parent().parent().parent()).toggle(),angular.element("div.partial-text",angular.element($event.target).parent().parent().parent()).toggle(),angular.element(" span.dots",angular.element($event.target).parent().parent().parent()).toggle(),angular.element(" a",angular.element($event.target).parent().parent()).toggle()))},angular.element("div.countries-filters").css("display","none"),angular.element("#filter2 h2").addClass("showChallenges"),$scope.toggleFilters=function(){$window.outerWidth<768&&(angular.element("#filter2 h2").toggleClass("showChallenges"),angular.element("div.countries-filters").slideToggle("slow"))},$scope.numberOfPages=function(){return Math.ceil($scope.amatrix.length/$scope.pageSize)},$scope.pagination=function(){$scope.arrayNumPages=[],$scope.filterPages=[];for(var i=0;i<$scope.numberOfPages();i++)$scope.arrayNumPages.push(i),i<$scope.maxPageButtons&&$scope.filterPages.push(i);return $scope.arrayNumPages},$scope.goToPage=function($index){$scope.currentPage=$index,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsEnd=$scope.elementsStart+$scope.pageSize},$scope.firstPage=function(){$scope.currentPage=0,$scope.elementsStart=0,$scope.pageStart=0,$scope.elementsEnd=$scope.pageSize,$scope.pagestart=10,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),updateText()},$scope.previousPage=function(){$scope.currentPage--,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsEnd=$scope.elementsStart+$scope.pageSize,$scope.pageStart=$scope.elementsStart,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),updateText(),$document.scrollTo(0,0,0)},$scope.nextPage=function(){$scope.currentPage<$scope.amatrix.length/$scope.pageSize-1&&($scope.currentPage++,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsStart+$scope.pageSize<=$scope.amatrix.length?$scope.elementsEnd=$scope.elementsStart+$scope.pageSize:$scope.elementsEnd=$scope.amatrix.length,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),$scope.pageStart=$scope.elementsStart),updateText(),$document.scrollTo(0,0,0)},$scope.lastPage=function(){var resto=Math.floor($scope.amatrix.length/$scope.pageSize);$scope.currentPage=resto,$scope.currentPage==$scope.numberOfPages()&&$scope.currentPage--,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsStart+$scope.pageSize<=$scope.amatrix.length?$scope.elementsEnd=$scope.elementsStart+$scope.pageSize:$scope.elementsEnd=$scope.amatrix.length,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),$scope.pageStart=$scope.elementsStart,updateText()},dataService.getMatrixAuthsCountries().then(function(data){var countryHasData=!1;if(data.data.resultset.map(function(elem){$stateParams.filter&&$stateParams.filter;if($scope.countries.push({country:elem[0],country_code:elem[1]}),elem[1]==$scope.pCountry&&(countryHasData=!0),$scope.pCountry==elem[1]){var tags=angular.element("div.selected--tags-wrapper"),html='<span class="selected-tag" id="country'+elem[0]+'" data-ng-click="deleteTag($event)">('+$scope.pCountry+") "+$scope.i18nLiterals["L"+elem[0]]+"</span>";tags.append($compile(html)($scope))}}),0==countryHasData&&null!=$scope.pCountry){var index=$scope.searchParams.countries.indexOf($scope.pCountry);$scope.searchParams.countries.splice(index,1),$scope.pCountry="AT",$scope.searchParams.countries.push($scope.pCountry);var html='<span class="selected-tag" id="country'+$scope.pCountry+'" data-ng-click="deleteTag($event)">('+$scope.pCountry+") "+$scope.i18nLiterals.L39+"</span>";angular.element("div.selected--tags-wrapper").append($compile(html)($scope)),search(null,"countries")}}).catch(function(err){throw err}),null!=$scope.pCountry&&$scope.searchParams.countries.push($scope.pCountry),null!=$scope.pInstitution){var tags=angular.element("div.selected--tags-wrapper");if("osh-authority"==$scope.pInstitution){$scope.searchParams.institutions.filter1=1;var html='<span class="selected-tag" id="institutionFilter1" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20614"></span>';tags.append($compile(html)($scope))}else if("compensation-and-insurance-body"==$scope.pInstitution){$scope.searchParams.institutions.filter2=1;var html='<span class="selected-tag" id="institutionFilter2" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20611"></span>';tags.append($compile(html)($scope))}else if("prevention-institute"==$scope.pInstitution){$scope.searchParams.institutions.filter3=1;var html='<span class="selected-tag" id="institutionFilter3" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20612"></span>';tags.append($compile(html)($scope))}else if("standardisation-body"==$scope.pInstitution){$scope.searchParams.institutions.filter4=1;var html='<span class="selected-tag" id="institutionFilter4" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20613"></span>';tags.append($compile(html)($scope))}}dataService.getAllMatrixAuthorities($scope.searchParams.countries,$scope.searchParams.institutions).then(function(data){$log.debug("getAllMatrixAuthorities"),data.data.resultset.map(function(elem){var param=$stateParams.filter?$stateParams.filter:void 0;$scope.amatrix.push({id:elem[0],country_name:elem[1],country_code:elem[2],osh_authority:elem[3],compensation:elem[4],prevention:elem[5],standardisation:elem[6],name_authority:elem[7],link_authority:elem[8],detail_authority:elem[9],param:param})}),updateText(),$scope.readMore=function(pMatrix){if(angular.element("div."+pMatrix).length)return angular.element("div."+pMatrix).height()>angular.element("div."+pMatrix).parent().height()}}).catch(function(err){throw err}),$scope.toggleCountryClick=function($event,$index){var element=angular.element($event.currentTarget),tags=angular.element("div.selected--tags-wrapper"),valueToJson=JSON.parse(element.attr("value"));if(element.prop("checked")){if($scope.searchParams.countries.push(valueToJson.country_code),"EU28"==valueToJson.country_code)var html='<span class="selected-tag" id="country'+valueToJson.country+'" data-ng-click="deleteTag($event)">'+$scope.i18nLiterals["L"+valueToJson.country]+"</span>";else var html='<span class="selected-tag" id="country'+valueToJson.country+'" data-ng-click="deleteTag($event)">('+valueToJson.country_code+") "+$scope.i18nLiterals["L"+valueToJson.country]+"</span>";tags.append($compile(html)($scope))}else $scope.searchParams.countries.splice($scope.searchParams.countries.indexOf(valueToJson.country_code),1),angular.element("span#country"+valueToJson.country).remove();search($event,"countries")},$scope.toggleInstitutionClick=function($event){var check1=$("#institution-filter-1:checked").length>0,check2=$("#institution-filter-2:checked").length>0,check3=$("#institution-filter-3:checked").length>0,check4=$("#institution-filter-4:checked").length>0,tags=angular.element("div.selected--tags-wrapper");if(check1){if($scope.searchParams.institutions.filter1=1,angular.element("span#institutionFilter1").length<=0){var html='<span class="selected-tag" id="institutionFilter1" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20614"></span>';tags.append($compile(html)($scope))}}else $scope.searchParams.institutions.filter1=0,angular.element("span#institutionFilter1").remove();if(check2){if($scope.searchParams.institutions.filter2=1,angular.element("span#institutionFilter2").length<=0){var html='<span class="selected-tag" id="institutionFilter2" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20611"></span>';tags.append($compile(html)($scope))}}else angular.element("span#institutionFilter2").remove(),$scope.searchParams.institutions.filter2=0;if(check3){if($scope.searchParams.institutions.filter3=1,angular.element("span#institutionFilter3").length<=0){var html='<span class="selected-tag" id="institutionFilter3" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20612"></span>';tags.append($compile(html)($scope))}}else angular.element("span#institutionFilter3").remove(),$scope.searchParams.institutions.filter3=0;if(check4){if($scope.searchParams.institutions.filter4=1,angular.element("span#institutionFilter4").length<=0){var html='<span class="selected-tag" id="institutionFilter4" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20613"></span>';tags.append($compile(html)($scope))}}else angular.element("span#institutionFilter4").remove(),$scope.searchParams.institutions.filter4=0;search($event,"institution")},$scope.deleteTag=function($event){var element=angular.element($event.currentTarget),countryName=element[0].id.slice(7,9);element[0].id.indexOf("country")>-1&&(countryName=element[0].id.replace("country",""));var countryCode=element[0].innerHTML.slice(1,3);"U2"==countryCode&&(countryCode="EU28",countryName=264);var quitChecked;-1!=$event.target.id.indexOf("country")?($scope.searchParams.countries.splice($scope.searchParams.countries.indexOf(countryCode),1),quitChecked=angular.element(".filter--dropdown--options #country-filter-"+countryName)):"institutionFilter1"==$event.target.id?(quitChecked=angular.element(".filter--dropdown--options #institution-filter-1"),$scope.searchParams.institutions.filter1=0):"institutionFilter2"==$event.target.id?(quitChecked=angular.element(".filter--dropdown--options #institution-filter-2"),$scope.searchParams.institutions.filter2=0):"institutionFilter3"==$event.target.id?(quitChecked=angular.element(".filter--dropdown--options #institution-filter-3"),$scope.searchParams.institutions.filter3=0):"institutionFilter4"==$event.target.id&&(quitChecked=angular.element(".filter--dropdown--options #institution-filter-4"),$scope.searchParams.institutions.filter4=0),element.remove(),quitChecked.prop("checked",!1),search($event,"country")},$scope.clickEnter=function($event){13!==$event.which&&1!==$event.which||search($event,"country")},$scope.openModal=function(matrix){angular.element("div#modalChart .modal-title").html($scope.i18nLiterals["L"+matrix.country_name]+" infrastructure")},angular.element("div#modalChart").click(function(text,$index,matrix){angular.element("div#modalChart").modal("hide")}).children().click(function(e){if(!$(e.target).is("a"))if($(e.target).is("button")||$(e.target).is("font")){if(!$(e.target).is("button")&&!$(e.target).is("font")&&!$(e.target).hasClass("close"))return!1}else if(!$(e.target).parent().is("button")&&!$(e.target).parent().hasClass("close"))return!1})}return controller.$inject=["$scope","$stateParams","$state","configService","$log","$document","dataService","$window","$sce","$compile","$timeout","$rootScope"],controller});