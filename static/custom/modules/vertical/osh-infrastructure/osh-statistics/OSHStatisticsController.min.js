define(function(require){"use strict";function controller($scope,$stateParams,$state,configService,$log,$document,dataService,$window,$sce,$compile,$timeout,$rootScope){function search($event,filter){dataService.getStatisticsFiltersData($scope.searchText,$scope.searchParams.categories,$scope.searchParams.countries).then(function(data){$scope.amatrix=dataService.dataMapper(data),$scope.firstPage(),$state.transitionTo("osh-statistics",{pCountry:0},{notify:!1})}).catch(function(err){throw err}),$scope.currentPage=0}var i18n=require("json!vertical/osh-authorities/i18n"),i18nLiterals=configService.getLiterals();$scope.i18n=i18n,$scope.i18nLiterals=i18nLiterals;var i18nSearch=require("json!horizontal/search/i18n");$scope.i18nSearch=i18nSearch,$scope.i18nSearchPlaceholder=i18nSearch["authorities-search-placeholder"],void 0!=$rootScope.defaultCountry.code&&1==$rootScope.defaultCountry.selectedByUser?$scope.pCountry=$rootScope.defaultCountry.code:$scope.pCountry=$stateParams.pCountry,$scope.countries=[],$scope.amatrix=[],$scope.searchParams={categories:{filter1:0,filter2:0,filter3:0},countries:[]},$scope.searchText="",$scope.selectedCountries=[],$scope.deleteCountryTags=[],$scope.currentPage=0,$scope.pageSize=5,$scope.elementsStart=0,$scope.elementsEnd=$scope.pageSize;var initialFilter=null!=$scope.pCountry?[$scope.pCountry]:[];$scope.paginationText="Displaying "+($scope.elementsStart+1)+"-"+$scope.elementsEnd+" of "+$scope.amatrix.length;var updateText=function(){$scope.paginationText="Displaying "+($scope.elementsStart+1)+"-"+$scope.elementsEnd+" of "+$scope.amatrix.length};$scope.selectOpened="",$scope.openSelect=function($event){var currentSelect=$event.target,nodename=currentSelect.nodeName;"LABEL"==nodename||"INPUT"==nodename?(currentSelect=$event.target.offsetParent.offsetParent,angular.element(currentSelect).addClass("viewOptions")):(currentSelect=$event.target.offsetParent.offsetParent,$scope.checkSelect(currentSelect))},$scope.checkSelect=function(elem){elem.className.indexOf("viewOptions")>0?angular.element(elem).removeClass("viewOptions"):(angular.element(".filter--dropdown--wrapper").removeClass("viewOptions"),angular.element(elem).addClass("viewOptions"))},$scope.closeSelect=function($event){angular.element(".filter--dropdown--wrapper").removeClass("viewOptions")},$scope.trimText=function(pVal,pNumCharacters){var shortText=pVal;if(null!=shortText){if(1==pNumCharacters)return $sce.trustAsHtml(shortText);$scope.newMaxCharacter=pNumCharacters;shortText.substring(0,$scope.newMaxCharacter).match("<a")&&(pNumCharacters+=150);var indexStart=shortText.indexOf("<a"),indexEnd=shortText.indexOf(">",indexStart);if(-1!=indexStart)for(;-1!=indexStart;){var link=shortText.substring(indexStart,indexEnd);$scope.newMaxCharacter=$scope.newMaxCharacter+link.length,indexStart=shortText.indexOf("<a",indexEnd),indexEnd=shortText.indexOf(">",indexStart)}return shortText.length>$scope.newMaxCharacter&&(shortText=$.trim(shortText).substring(0,pNumCharacters).split(" ").slice(0,-1).join(" ")+"<span class='dots'>...</span>"),$sce.trustAsHtml(shortText)}},$scope.toggleText=function($event){$(this).is(":visible")&&(angular.element("div.complete-text",angular.element($event.target).parent().parent()).toggle(),angular.element("div.partial-text",angular.element($event.target).parent().parent()).toggle()),angular.element(" span.dots",angular.element($event.target).parent().parent()).toggle(),angular.element(" a",angular.element($event.target).parent()).toggle()},angular.element("div.countries-filters").css("display","none"),angular.element("#filter2 h2").addClass("showChallenges"),$scope.toggleFilters=function(){$window.outerWidth<768&&(angular.element("#filter2 h2").toggleClass("showChallenges"),angular.element("div.countries-filters").slideToggle("slow"))},$scope.numberOfPages=function(){return Math.ceil($scope.amatrix.length/$scope.pageSize)},$scope.pagination=function(){$scope.arrayNumPages=[],$scope.filterPages=[];for(var i=0;i<$scope.numberOfPages();i++)$scope.arrayNumPages.push(i),i<$scope.maxPageButtons&&$scope.filterPages.push(i);return $scope.arrayNumPages},$scope.goToPage=function($index){$scope.currentPage=$index,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsEnd=$scope.elementsStart+$scope.pageSize},$scope.firstPage=function(){$scope.currentPage=0,$scope.elementsStart=0,$scope.pageStart=0,$scope.elementsEnd=$scope.pageSize,$scope.pagestart=10,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),updateText()},$scope.previousPage=function(){$scope.currentPage--,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsEnd=$scope.elementsStart+$scope.pageSize,$scope.pageStart=$scope.elementsStart,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),updateText()},$scope.nextPage=function(){$scope.currentPage<$scope.amatrix.length/$scope.pageSize-1&&($scope.currentPage++,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsStart+$scope.pageSize<=$scope.amatrix.length?$scope.elementsEnd=$scope.elementsStart+$scope.pageSize:$scope.elementsEnd=$scope.amatrix.length,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),$scope.pageStart=$scope.elementsStart),updateText()},$scope.lastPage=function(){var resto=Math.floor($scope.amatrix.length/$scope.pageSize);$scope.currentPage=resto,$scope.currentPage==$scope.numberOfPages()&&$scope.currentPage--,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsStart+$scope.pageSize<=$scope.amatrix.length?$scope.elementsEnd=$scope.elementsStart+$scope.pageSize:$scope.elementsEnd=$scope.amatrix.length,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),$scope.pageStart=$scope.elementsStart,updateText()},$document.scrollTo(0,0,0),dataService.getAllMatrixStatistics(initialFilter).then(function(data){$log.debug("getAllMatrixStatistics"),data.data.resultset.map(function(elem){var param=$stateParams.filter?$stateParams.filter:void 0;$scope.amatrix.push({country_id:elem[0],country_name:elem[1],country_code:elem[2],osh_statistics:elem[3],surveys:elem[4],research_institutes:elem[5],name_institution:elem[6],detail_institution:elem[7],param:param})}),$log.warn($scope.amatrix),updateText(),$scope.readMore=function(pMatrix){if(angular.element("div."+pMatrix).length)return angular.element("div."+pMatrix).height()>angular.element("div."+pMatrix).parent().height()}}).catch(function(err){throw err}),dataService.getMatrixStatisticsCountries().then(function(data){var countryHasData=!1;if(data.data.resultset.map(function(elem){$stateParams.filter&&$stateParams.filter;if($scope.countries.push({country:elem[0],country_code:elem[1]}),elem[1]==$scope.pCountry&&(countryHasData=!0),elem[1]==$scope.pCountry){var tags=angular.element("div.selected--tags-wrapper"),html='<span class="selected-tag" id="country'+elem[1]+'" data-ng-click="deleteTag($event)">('+elem[1]+") "+$scope.i18nLiterals["L"+elem[0]]+"</span>";tags.append($compile(html)($scope)),$scope.searchParams.countries.push(elem[1].toString())}}),0==countryHasData&&null!=$scope.pCountry){var index=$scope.searchParams.countries.indexOf($scope.pCountry);$scope.searchParams.countries.splice(index,1),$scope.pCountry="AT",$scope.searchParams.countries.push("39");var html='<span class="selected-tag" id="country'+$scope.pCountry+'" data-ng-click="deleteTag($event)">('+$scope.pCountry+") "+$scope.i18nLiterals.L39+"</span>";angular.element("div.selected--tags-wrapper").append($compile(html)($scope)),search(null,"countries")}}).catch(function(err){throw err}),$scope.toggleCountryClick=function($event,$index){var element=angular.element($event.currentTarget),tags=angular.element("div.selected--tags-wrapper"),valueToJson=JSON.parse(element.attr("value"));element.prop("checked")?$scope.searchParams.countries.push(valueToJson.country):($scope.searchParams.countries.splice($scope.searchParams.countries.indexOf(valueToJson.country),1),angular.element("span#country"+valueToJson.country).remove());for(var tags=angular.element("div.selected--tags-wrapper"),i=0;i<$scope.searchParams.countries.length;i++)if(angular.element("span#country"+$scope.searchParams.countries[i]).length<=0){var html='<span class="selected-tag" id="country'+$scope.searchParams.countries[i]+'" data-ng-click="deleteTag($event)">('+valueToJson.country_code+") "+$scope.i18nLiterals["L"+$scope.searchParams.countries[i]]+"</span>";tags.append($compile(html)($scope))}search($event,"countries")},$scope.toggleCategoryClick=function($event){var check1=$("#category-filter-1:checked").length>0,check2=$("#category-filter-2:checked").length>0,check3=$("#category-filter-3:checked").length>0,tags=angular.element("div.selected--tags-wrapper");if(check1){if($scope.searchParams.categories.filter1=1,angular.element("span#categoryFilter1").length<=0){var html='<span class="selected-tag" id="categoryFilter1" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20714"></span>';tags.append($compile(html)($scope))}}else $scope.searchParams.categories.filter1=0,angular.element("span#categoryFilter1").remove();if(check2){if($scope.searchParams.categories.filter2=1,angular.element("span#categoryFilter2").length<=0){var html='<span class="selected-tag" id="categoryFilter2" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20715"></span>';tags.append($compile(html)($scope))}}else angular.element("span#categoryFilter2").remove(),$scope.searchParams.categories.filter2=0;if(check3){if($scope.searchParams.categories.filter3=1,angular.element("span#categoryFilter3").length<=0){var html='<span class="selected-tag" id="categoryFilter3" data-ng-click="deleteTag($event)" data-ng-bind="i18nLiterals.L20716"></span>';tags.append($compile(html)($scope))}}else angular.element("span#categoryFilter3").remove(),$scope.searchParams.categories.filter3=0;search($event,"category")},$scope.confirmCountrySelection=function($event){$scope.selectedCountries.sort();for(var tags=angular.element("div.selected--tags-wrapper"),i=0;i<$scope.selectedCountries.length;i++)if(angular.element("span#country"+$scope.selectedCountries[i]).length<=0){var html='<span class="selected-tag" id="country'+$scope.selectedCountries[i]+'" data-ng-click="deleteTag($event)">'+$scope.i18nLiterals["L"+$scope.selectedCountries[i]]+"</span>";tags.append($compile(html)($scope))}for(var i=0;i<$scope.deleteCountryTags.length;i++)angular.element("#country-filter-"+$scope.deleteCountryTags[i]+":checked").length<=0&&angular.element("span#country"+$scope.deleteCountryTags[i]).remove();$scope.deleteCountryTags=[],$scope.searchParams.countries=$scope.selectedCountries,search($event,"countries")},$scope.confirmCategorySelection=function($event){var par,check1=$("#category-filter-1:checked").length>0,check2=$("#category-filter-2:checked").length>0,check3=$("#category-filter-3:checked").length>0,tags=angular.element("div.selected--tags-wrapper");if(check1){if($scope.searchParams.categories.filter1=1,par="category",angular.element("span#categoryFilter1").length<=0){var html='<span class="selected-tag" id="categoryFilter1" data-ng-click="deleteTag($event)">OSH Statistics</span>';tags.append($compile(html)($scope))}}else angular.element("span#categoryFilter1").remove();if(check2){if($scope.searchParams.categories.filter2=1,par="category",angular.element("span#categoryFilter2").length<=0){var html='<span class="selected-tag" id="categoryFilter2" data-ng-click="deleteTag($event)">Surveys</span>';tags.append($compile(html)($scope))}}else angular.element("span#categoryFilter2").remove();if(check3){if($scope.searchParams.categories.filter3=1,par="category",angular.element("span#categoryFilter3").length<=0){var html='<span class="selected-tag" id="categoryFilter3" data-ng-click="deleteTag($event)">Research Institutes</span>';tags.append($compile(html)($scope))}}else angular.element("span#categoryFilter3").remove();search($event,par)},$scope.deleteTag=function($event){var quitChecked,element=angular.element($event.currentTarget),countryId=parseInt(element[0].id.slice(7,10));-1!=$event.target.id.indexOf("country")?($scope.searchParams.countries.splice($scope.searchParams.countries.indexOf(countryId),1),quitChecked=angular.element(".filter--dropdown--options #country-filter-"+countryId)):"categoryFilter1"==$event.target.id?(quitChecked=angular.element(".filter--dropdown--options #category-filter-1"),$scope.searchParams.categories.filter1=0):"categoryFilter2"==$event.target.id?(quitChecked=angular.element(".filter--dropdown--options #category-filter-2"),$scope.searchParams.categories.filter2=0):"categoryFilter3"==$event.target.id&&(quitChecked=angular.element(".filter--dropdown--options #category-filter-3"),$scope.searchParams.categories.filter3=0),element.remove(),quitChecked.prop("checked",!1),search($event,"country")},$scope.clickEnter=function($event){13!==$event.which&&1!==$event.which||search($event,"search")},$scope.openModal=function(matrix){angular.element("div#modalChart .modal-title").html($scope.i18nLiterals["L"+matrix.country_name]+" infrastructure")}}return controller.$inject=["$scope","$stateParams","$state","configService","$log","$document","dataService","$window","$sce","$compile","$timeout","$rootScope"],controller});