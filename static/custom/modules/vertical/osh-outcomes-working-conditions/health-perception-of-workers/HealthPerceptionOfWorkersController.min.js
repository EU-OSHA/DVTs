define(function(require){"use strict";function controller($scope,$stateParams,$state,configService,$log,$document,dataService,$window,$sce,$compile,$timeout){function search($event,filter){dataService.applyHealthPerceptionFilters($scope.datasetEurofound,$scope.EUROSTAT,$scope.searchParams.countries).then(function(data){$scope.amatrix=dataService.dataMapper(data),$scope.firstPage(),$state.transitionTo("health-perception-of-workers",{},{notify:!1})}).catch(function(err){throw err}),$scope.currentPage=0}var i18n=require("json!vertical/osh-authorities/i18n"),i18nLiterals=configService.getLiterals();$scope.i18n=i18n,$scope.i18nLiterals=i18nLiterals,$scope.datasetList=configService.getDatasets(),$scope.EUROSTAT=$scope.datasetList.EUROSTAT,$scope.datasetEurofound=$scope.datasetList.Eurofound,$scope.countries=[],$scope.amatrix=[],$scope.EUData={},$scope.searchParams={countries:[]},$scope.selectedCountries=[],$scope.deleteCountryTags=[];var resolution=window.resolution;$(window).on("resize",function(e){window.outerWidth!=resolution&&(resolution=window.resolution,$scope.pageSize=resolution>=768&&resolution<=1024?16:15,$scope.elementsEnd=$scope.pageSize,$scope.$apply(),updateText())}),$scope.currentPage=0,$scope.pageSize=resolution>=768&&resolution<=1024?16:15,$scope.elementsStart=0,$scope.elementsEnd=$scope.pageSize,$scope.paginationText="Displaying "+($scope.elementsStart+1)+"-"+$scope.elementsEnd+" of "+$scope.amatrix.length;var updateText=function(){$scope.paginationText="Displaying "+($scope.elementsStart+1)+"-"+$scope.elementsEnd+" of "+$scope.amatrix.length};if($scope.selectOpened="",$scope.openSelect=function($event){var currentSelect=$event.target,nodename=currentSelect.nodeName;"LABEL"==nodename||"INPUT"==nodename?(currentSelect=$event.target.offsetParent.offsetParent,angular.element(currentSelect).addClass("viewOptions")):(currentSelect=$event.target.offsetParent.offsetParent,$scope.checkSelect(currentSelect))},$scope.checkSelect=function(elem){elem.className.indexOf("viewOptions")>0?angular.element(elem).removeClass("viewOptions"):(angular.element(".filter--dropdown--wrapper").removeClass("viewOptions"),angular.element(elem).addClass("viewOptions"))},$scope.closeSelect=function($event){angular.element(".filter--dropdown--wrapper").removeClass("viewOptions")},angular.element("div.countries-filters").css("display","none"),angular.element("#filter2 h2").addClass("showChallenges"),$scope.toggleFilters=function(){$window.outerWidth<768&&(angular.element("#filter2 h2").toggleClass("showChallenges"),angular.element("div.countries-filters").slideToggle("slow"))},$scope.numberOfPages=function(){return Math.ceil($scope.amatrix.length/$scope.pageSize)},$scope.pagination=function(){$scope.arrayNumPages=[],$scope.filterPages=[];for(var i=0;i<$scope.numberOfPages();i++)$scope.arrayNumPages.push(i),i<$scope.maxPageButtons&&$scope.filterPages.push(i);return $scope.arrayNumPages},$scope.goToPage=function($index){$scope.currentPage=$index,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsEnd=$scope.elementsStart+$scope.pageSize},$scope.firstPage=function(){$scope.currentPage=0,$scope.elementsStart=0,$scope.pageStart=0,$scope.elementsEnd=$scope.pageSize,$scope.pagestart=10,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),updateText()},$scope.previousPage=function(){$scope.currentPage--,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsEnd=$scope.elementsStart+$scope.pageSize,$scope.pageStart=$scope.elementsStart,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),updateText()},$scope.nextPage=function(){$scope.currentPage<$scope.amatrix.length/$scope.pageSize-1&&($scope.currentPage++,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsStart+$scope.pageSize<=$scope.amatrix.length?$scope.elementsEnd=$scope.elementsStart+$scope.pageSize:$scope.elementsEnd=$scope.amatrix.length,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),$scope.pageStart=$scope.elementsStart),updateText()},$scope.lastPage=function(){var resto=Math.floor($scope.amatrix.length/$scope.pageSize);$scope.currentPage=resto,$scope.currentPage==$scope.numberOfPages()&&$scope.currentPage--,$scope.elementsStart=$scope.currentPage*$scope.pageSize,$scope.elementsStart+$scope.pageSize<=$scope.amatrix.length?$scope.elementsEnd=$scope.elementsStart+$scope.pageSize:$scope.elementsEnd=$scope.amatrix.length,$scope.elementsEnd>$scope.amatrix.length&&($scope.elementsEnd=$scope.amatrix.length),$scope.pageStart=$scope.elementsStart,updateText()},$document.scrollTo(0,0,0),dataService.getHealthPerceptionData($scope.datasetEurofound,$scope.EUROSTAT).then(function(data){$log.debug("getHealthPerceptionData"),data.data.resultset.map(function(elem){$stateParams.filter&&$stateParams.filter;"EU28"==elem[1]?$scope.EUData={country_name:elem[0],country_code:elem[1],satisfaction_working:elem[2],health_negative:elem[3],health_problem:elem[4],absence:elem[5],sick_at_work:elem[6],job_till_60:elem[7]}:$scope.amatrix.push({country_name:elem[0],country_code:elem[1],satisfaction_working:elem[2],health_negative:elem[3],health_problem:elem[4],absence:elem[5],sick_at_work:elem[6],job_till_60:elem[7]})}),updateText(),$scope.readMore=function(pMatrix){if(angular.element("div."+pMatrix).length)return angular.element("div."+pMatrix).height()>angular.element("div."+pMatrix).parent().height()}}).catch(function(err){throw err}),dataService.getHealthPerceptionCountries().then(function(data){data.data.resultset.map(function(elem){$stateParams.filter&&$stateParams.filter;$scope.countries.push({country:elem[0],country_code:elem[1]})})}).catch(function(err){throw err}),$scope.toggleCountryClick=function($event,$index){var element=angular.element($event.currentTarget),tags=angular.element("div.selected--tags-wrapper"),valueToJson=JSON.parse(element.attr("value"));element.prop("checked")?$scope.searchParams.countries.push(valueToJson.country):($scope.searchParams.countries.splice($scope.searchParams.countries.indexOf(valueToJson.country),1),angular.element("span#country"+valueToJson.country).remove()),$scope.selectedCountries.sort();for(var tags=angular.element("div.selected--tags-wrapper"),i=0;i<$scope.searchParams.countries.length;i++)if(angular.element("span#country"+$scope.searchParams.countries[i]).length<=0){var html='<span class="selected-tag" id="country'+$scope.searchParams.countries[i]+'" data-ng-click="deleteTag($event)">('+valueToJson.country_code+") "+$scope.i18nLiterals["L"+$scope.searchParams.countries[i]]+"</span>";tags.append($compile(html)($scope))}search($event,"countries")},$scope.confirmCountrySelection=function($event){$scope.selectedCountries.sort();for(var tags=angular.element("div.selected--tags-wrapper"),i=0;i<$scope.selectedCountries.length;i++)if(angular.element("span#country"+$scope.selectedCountries[i]).length<=0){var html='<span class="selected-tag" id="country'+$scope.selectedCountries[i]+'" data-ng-click="deleteTag($event)">'+$scope.i18nLiterals["L"+$scope.selectedCountries[i]]+"</span>";tags.append($compile(html)($scope))}for(var i=0;i<$scope.deleteCountryTags.length;i++)angular.element("#country-filter-"+$scope.deleteCountryTags[i]+":checked").length<=0&&angular.element("span#country"+$scope.deleteCountryTags[i]).remove();$scope.deleteCountryTags=[],$scope.searchParams.countries=$scope.selectedCountries,search($event,"countries")},$scope.deleteTag=function($event){var quitChecked,element=angular.element($event.currentTarget),countryId=parseInt(element[0].id.slice(7,10));-1!=$event.target.id.indexOf("country")&&($scope.searchParams.countries.splice($scope.searchParams.countries.indexOf(countryId),1),quitChecked=angular.element(".filter--dropdown--options #country-filter-"+countryId)),element.remove(),quitChecked.prop("checked",!1),search($event,"country")},screen.width>767){$(".highlited--data--section").affix({offset:{top:420}})}else;}return controller.$inject=["$scope","$stateParams","$state","configService","$log","$document","dataService","$window","$sce","$compile","$timeout"],controller});